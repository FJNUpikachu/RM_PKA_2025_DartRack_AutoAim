# dart_detector 功能包说明

## 概述
`dart_detector` 是一个基于ROS 2的飞镖检测功能包，支持通过摄像头实时检测或视频文件离线分析目标物体。该功能包结合HSV颜色阈值分割和形状特征识别（圆形度、尺寸筛选等）实现精准检测，并提供截图、视频录制等辅助功能，同时支持调试模式便于参数优化。


## 核心功能
- **双模式运行**：支持`camera`（相机实时检测）和`video`（视频文件离线检测）两种模式
- **目标检测**：基于HSV颜色空间提取特定颜色区域，结合圆形度、尺寸范围、长宽比等特征筛选目标
- **可视化输出**：发布原始图像和带检测结果的处理后图像（含目标标记）
- **截图功能**：支持手动触发截图和定时自动截图，可分别配置是否保存原始图像和处理后图像
- **视频录制**：相机模式下可录制原始图像流为视频文件，支持自定义帧率和编码格式
- **调试模式**：提供详细的视觉反馈（如ROI区域框、轮廓显示）和日志信息，便于参数调优


## 节点信息
| 节点名称              | 类型       | 说明                                   |
|-----------------------|------------|----------------------------------------|
| `dart_detector_node`  | 主节点     | 负责图像获取、处理、检测及辅助功能协调 |


## 话题接口

### 订阅话题
| 话题名称       | 消息类型               | 说明                          |
|----------------|------------------------|-------------------------------|
| `image_raw`    | `sensor_msgs/msg/Image` | 原始图像输入（仅相机模式使用） |


### 发布话题
| 话题名称           | 消息类型               | 说明                                  |
|--------------------|------------------------|---------------------------------------|
| `raw_image`        | `sensor_msgs/msg/Image` | 转发的原始图像（相机/视频模式均输出）  |
| `processed_image`  | `sensor_msgs/msg/Image` | 带检测结果的处理后图像（含目标标记）  |


## 服务接口
| 服务名称           | 服务类型               | 说明                          |
|--------------------|------------------------|-------------------------------|
| `take_screenshot`  | `std_srvs/srv/Trigger`  | 手动触发截图服务（无参数）    |


## 参数配置
所有参数可通过`config/detect_params.yaml`文件配置，或通过命令行参数覆盖。主要参数如下：

### 运行模式参数
| 参数名           | 类型    | 默认值    | 说明                                  |
|------------------|---------|-----------|---------------------------------------|
| `mode`           | string  | "camera"  | 运行模式："camera"（相机）或"video"（视频） |
| `video_path`     | string  | ""        | 视频文件路径（仅video模式有效）        |
| `video_fps`      | double  | 30.0      | 视频帧率（无法从文件获取时使用）       |


### HSV颜色阈值（目标颜色提取）
| 参数名           | 类型    | 默认值    | 说明                          |
|------------------|---------|-----------|-------------------------------|
| `h_min`          | double  | 40.0      | HSV色相最小值（0-179）        |
| `h_max`          | double  | 80.0      | HSV色相最大值（0-179）        |
| `s_min`          | double  | 100.0     | HSV饱和度最小值（0-255）      |
| `s_max`          | double  | 255.0     | HSV饱和度最大值（0-255）      |
| `v_min`          | double  | 100.0     | HSV明度最小值（0-255）        |
| `v_max`          | double  | 255.0     | HSV明度最大值（0-255）        |


### ROI区域参数（感兴趣区域）
| 参数名           | 类型    | 默认值    | 说明                          |
|------------------|---------|-----------|-------------------------------|
| `y_min`          | int     | 100       | ROI起始行（像素，纵向范围）   |
| `y_max`          | int     | 500       | ROI结束行（像素，纵向范围）   |


### 形状筛选参数
| 参数名                   | 类型    | 默认值    | 说明                                  |
|--------------------------|---------|-----------|---------------------------------------|
| `aspect_ratio_threshold` | double  | 1.2       | 外接矩形长宽比阈值（≤该值视为近似圆形） |
| `circularity_threshold`  | double  | 0.75      | 圆形度阈值（≥该值视为圆形，范围0-1）   |
| `min_radius`             | double  | 5.0       | 目标最小半径（像素）                  |
| `max_radius`             | double  | 50.0      | 目标最大半径（像素）                  |


### 调试参数
| 参数名           | 类型    | 默认值    | 说明                                  |
|------------------|---------|-----------|---------------------------------------|
| `enable_debug`   | bool    | false     | 调试模式开关：<br>- true：显示ROI绿框、所有轮廓、未检测提示文字<br>- false：仅显示最终检测结果 |


### 截图功能参数
| 参数名                   | 类型    | 默认值        | 说明                          |
|--------------------------|---------|---------------|-------------------------------|
| `screenshot_path`        | string  | "./screenshots" | 截图保存路径                  |
| `enable_auto_screenshot` | bool    | false         | 自动截图开关                  |
| `screenshot_interval`    | double  | 10.0          | 自动截图间隔（秒，最小1秒）   |
| `save_raw_image`         | bool    | true          | 是否保存原始图像              |
| `save_processed_image`   | bool    | true          | 是否保存处理后图像            |


### 视频录制参数（仅camera模式）
| 参数名                   | 类型    | 默认值        | 说明                          |
|--------------------------|---------|---------------|-------------------------------|
| `enable_video_recording` | bool    | false         | 视频录制开关                  |
| `recording_path`         | string  | "./recordings" | 视频保存路径                  |
| `recording_fps`          | double  | 30.0          | 录制视频帧率                  |
| `fourcc_codec`           | string  | "mp4v"        | 视频编码格式（如mp4v、avc1）  |


## 使用方法

### 1. 编译功能包
在ROS 2工作空间中编译：
```bash
rm -rf build install log
colcon build --packages-select dart_detector
source install/setup.bash
```

### 2. 启动节点

相机模式（默认）
```bash
ros2 launch dart_detector dart.launch.py
```

视频模式
指定视频文件路径：
```bash
ros2 launch dart_detector dart.launch.py mode:=video video_path:=/path/to/your/video.mp4
```

自定义参数启动
通过命令行覆盖配置文件参数（例如启用调试模式）：
```bash
ros2 launch dart_detector dart.launch.py enable_debug:=true
```

### 3. 手动触发截图
调用服务触发截图：
```bash
ros2 service call /take_screenshot std_srvs/srv/Trigger {}
```
截图将保存到 screenshot_path配置的目录，文件名格式为时间戳_raw.png（原始图像）和时间戳_processed.png（处理后图像）。


## 注意事项

- 首次运行时，功能包会自动创建截图和视频保存目录（若不存在）
- 视频编码格式需根据系统支持情况调整（常用mp4v、avc1、mjpg）
- ROI 区域参数需根据实际场景调整，以减少无关区域干扰
- HSV 阈值参数需根据目标物体颜色在实际环境中校准

